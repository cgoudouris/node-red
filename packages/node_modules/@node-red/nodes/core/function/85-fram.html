<!--
  Copyright JS Foundation and other contributors, http://js.foundation

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<script type="text/html" data-template-name="fram">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="common.label.name"></span></label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]common.label.name">
    </div>
    
    <div class="form-row">
        <label for="node-input-functionName"><i class="fa fa-sitemap"></i> Function Name</label>
        <input type="text" id="node-input-functionName" placeholder="FRAM Function">
    </div>
    
    <!-- Advanced FRAM Configuration Section -->
    <div class="form-row">
        <h4 style="margin-top: 20px; margin-bottom: 10px; color: #666;"><i class="fa fa-cog"></i> FRAM Analysis Configuration</h4>
    </div>
    
    <div class="form-row">
        <label for="node-input-interpretationProfile"><i class="fa fa-user-circle"></i> Interpretation Profile</label>
        <select id="node-input-interpretationProfile">
            <option value="technological">Technological Systems</option>
            <option value="human">Human Factors</option>
            <option value="organizational">Organizational Processes</option>
        </select>
        <div class="form-tips" id="profile-description" style="margin-top: 5px; font-size: 12px; color: #666;"></div>
    </div>
    
    <div class="form-row">
        <label for="node-input-variabilityMode"><i class="fa fa-cogs"></i> Variability Mode</label>
        <select id="node-input-variabilityMode">
            <option value="low">Low Variability</option>
            <option value="normal">Normal Variability</option>
            <option value="high">High Variability</option>
        </select>
    </div>
    
    <div class="form-row">
        <label for="node-input-timeConstraint"><i class="fa fa-clock-o"></i> Time Constraint</label>
        <input type="text" id="node-input-timeConstraint" placeholder="e.g., 5s, 10m, 1h">
    </div>
    
    <div class="form-row">
        <label for="node-input-resourceThreshold"><i class="fa fa-battery-half"></i> Resource Threshold</label>
        <input type="number" id="node-input-resourceThreshold" placeholder="100" min="0" max="1000">
    </div>
    
    <!-- Advanced Features Section -->
    <div class="form-row">
        <h4 style="margin-top: 20px; margin-bottom: 10px; color: #666;"><i class="fa fa-star"></i> Advanced Features</h4>
    </div>
    
    <div class="form-row">
        <label for="node-input-enableResonance">&nbsp;</label>
        <input type="checkbox" id="node-input-enableResonance" style="display:inline-block; width:15px; vertical-align:baseline;">
        <span>Enable Functional Resonance Detection</span>
    </div>
    
    <div class="form-row">
        <label for="node-input-enableMetadata">&nbsp;</label>
        <input type="checkbox" id="node-input-enableMetadata" style="display:inline-block; width:15px; vertical-align:baseline;">
        <span>Enable Metadata Facility (FMV Compatible)</span>
    </div>
    
    <div class="form-row">
        <label for="node-input-advancedAnalysis">&nbsp;</label>
        <input type="checkbox" id="node-input-advancedAnalysis" style="display:inline-block; width:15px; vertical-align:baseline;">
        <span>Enable Advanced FRAM Analysis</span>
    </div>
    
    <div class="form-row">
        <label for="node-input-standardizedReporting">&nbsp;</label>
        <input type="checkbox" id="node-input-standardizedReporting" style="display:inline-block; width:15px; vertical-align:baseline;">
        <span>Generate Standardized Reports</span>
    </div>
    
    <!-- Hierarchical Grouping Section -->
    <div class="form-row" id="metadata-options" style="display: none;">
        <h4 style="margin-top: 15px; margin-bottom: 10px; color: #666;"><i class="fa fa-sitemap"></i> Hierarchical Grouping</h4>
    </div>
    
    <div class="form-row" id="hierarchical-group-row" style="display: none;">
        <label for="node-input-hierarchicalGroup"><i class="fa fa-layer-group"></i> Group Name</label>
        <input type="text" id="node-input-hierarchicalGroup" placeholder="e.g., Control_System, Human_Interface">
    </div>
    
    <!-- Ontology Mapping Section -->
    <div class="form-row" id="ontology-header" style="display: none;">
        <h4 style="margin-top: 15px; margin-bottom: 10px; color: #666;"><i class="fa fa-share-alt"></i> Ontology Mapping</h4>
    </div>
    
    <div class="form-row" id="ontology-options" style="display: none;">
        <label style="width: 100%;"><i class="fa fa-info-circle"></i> Map FRAM aspects to ontological concepts:</label>
        <div style="margin-left: 20px; margin-top: 10px;">
            <div class="form-row" style="margin: 5px 0;">
                <label style="width: 80px;">Input:</label>
                <input type="text" id="node-input-ontology-input" placeholder="Concept mapping" style="width: 200px;">
            </div>
            <div class="form-row" style="margin: 5px 0;">
                <label style="width: 80px;">Resources:</label>
                <input type="text" id="node-input-ontology-resources" placeholder="Concept mapping" style="width: 200px;">
            </div>
            <div class="form-row" style="margin: 5px 0;">
                <label style="width: 80px;">Control:</label>
                <input type="text" id="node-input-ontology-control" placeholder="Concept mapping" style="width: 200px;">
            </div>
        </div>
    </div>
    
    <!-- FRAM Aspects Information -->
    <div class="form-row">
        <h4 style="margin-top: 20px; margin-bottom: 10px; color: #666;"><i class="fa fa-info-circle"></i> FRAM Aspects Mapping</h4>
        <div style="margin-left: 20px; font-size: 12px; color: #666;">
            <div><strong>Input 1:</strong> Input (I) - What triggers the function</div>
            <div><strong>Input 2:</strong> Preconditions (P) - Required conditions</div>
            <div><strong>Input 3:</strong> Resources (R) - Required resources</div>
            <div><strong>Input 4:</strong> Time (T) - Timing constraints</div>
            <div><strong>Input 5:</strong> Control (C) - Control/supervision</div>
            <div><strong>Output:</strong> Output (O) - Function result</div>
        </div>
    </div>
    
    <!-- Profile-Specific Information -->
    <div class="form-row">
        <div id="profile-info" style="margin-top: 15px; padding: 10px; background: #f0f0f0; border-radius: 4px; font-size: 12px;">
            <div id="profile-details"></div>
        </div>
    </div>
</script>

<script type="text/html" data-help-name="fram">
    <p>An advanced FRAM (Functional Resonance Analysis Method) node for modeling complex socio-technical systems with sophisticated interpretation profiles and FMV-compatible features.</p>
    
    <h3>Interpretation Profiles</h3>
    <p>Choose from three specialized analysis profiles:</p>
    <dl class="message-properties">
        <dt>Technological</dt>
        <dd>Optimized for technical systems with high precision timing and processing requirements</dd>
        
        <dt>Human</dt>
        <dd>Focused on human factors analysis with cognitive load and decision-making considerations</dd>
        
        <dt>Organizational</dt>
        <dd>Designed for organizational processes with policy compliance and resource management focus</dd>
    </dl>
    
    <h3>Inputs</h3>
    <p>This node has 5 inputs representing the FRAM aspects:</p>
    <dl class="message-properties">
        <dt>Input 1 - Input (I)</dt>
        <dd>What starts or triggers the function execution</dd>
        
        <dt>Input 2 - Preconditions (P)</dt>
        <dd>Conditions that must be fulfilled before execution</dd>
        
        <dt>Input 3 - Resources (R)</dt>
        <dd>Resources needed to perform the function</dd>
        
        <dt>Input 4 - Time (T)</dt>
        <dd>Temporal aspects and timing constraints</dd>
        
        <dt>Input 5 - Control (C)</dt>
        <dd>How the function is monitored or controlled</dd>
    </dl>
    
    <h3>Advanced Input Properties</h3>
    <dl class="message-properties">
        <dt>msg.framAspect</dt>
        <dd>Explicitly specify which FRAM aspect this input represents</dd>
        
        <dt>msg.metadata</dt>
        <dd>Additional metadata for FMV-compatible analysis (when metadata facility is enabled)</dd>
        
        <dt>msg.metadata.hierarchicalGroup</dt>
        <dd>Hierarchical grouping information for complex model organization</dd>
        
        <dt>msg.metadata.ontologyMapping</dt>
        <dd>Ontological concept mappings for semantic analysis</dd>
    </dl>
    
    <h3>Output</h3>
    <dl class="message-properties">
        <dt>payload.result</dt>
        <dd>The processed result with interpretation profile-specific analysis</dd>
        
        <dt>payload.interpretationProfile</dt>
        <dd>The active interpretation profile used for analysis</dd>
        
        <dt>payload.variability</dt>
        <dd>Comprehensive variability analysis including profile-weighted calculations</dd>
        
        <dt>payload.performance</dt>
        <dd>Enhanced performance characteristics based on profile requirements</dd>
        
        <dt>payload.resonance</dt>
        <dd>Advanced functional resonance detection with profile-specific patterns</dd>
        
        <dt>payload.advancedAnalysis</dt>
        <dd>Detailed analysis including compliance assessment, risk evaluation, and recommendations (when enabled)</dd>
        
        <dt>payload.standardReport</dt>
        <dd>FMV-compatible standardized analysis report (when enabled)</dd>
        
        <dt>payload.metadata</dt>
        <dd>Processed metadata and hierarchical context information</dd>
        
        <dt>payload.ontologyData</dt>
        <dd>Ontological mappings and semantic analysis results</dd>
    </dl>
    
    <h3>Advanced Features</h3>
    <ul>
        <li><strong>Metadata Facility:</strong> FMV-compatible metadata processing for enhanced analysis</li>
        <li><strong>Hierarchical Grouping:</strong> Organize functions within complex system hierarchies</li>
        <li><strong>Ontology Mapping:</strong> Map FRAM aspects to domain-specific ontological concepts</li>
        <li><strong>Standardized Reporting:</strong> Generate comprehensive reports compatible with FMV standards</li>
        <li><strong>Advanced Analysis:</strong> Profile compliance assessment, risk analysis, and improvement recommendations</li>
    </ul>
    
    <h3>Profile-Specific Behavior</h3>
    <p><strong>Technological Systems:</strong> Emphasizes precision, timing, and system performance metrics. Requires input and resources for execution.</p>
    <p><strong>Human Factors:</strong> Focuses on cognitive load, decision quality, and situational awareness. Requires input and proper authorization/training.</p>
    <p><strong>Organizational Processes:</strong> Prioritizes policy compliance, resource allocation, and coordination. Requires preconditions and resources for execution.</p>
    
    <h3>Example Usage</h3>
    <p>Basic input with aspect identification:</p>
    <pre>{
  "payload": "sensor_data",
  "topic": "input_sensor",
  "framAspect": "input"
}</pre>
    
    <p>Advanced input with metadata:</p>
    <pre>{
  "payload": "system_ready",
  "framAspect": "preconditions", 
  "metadata": {
    "hierarchicalGroup": "control_system",
    "qualityLevel": "high",
    "certificationStatus": "validated"
  }
}</pre>
    
    <h3>Details</h3>
    <p>This advanced FRAM node implements sophisticated modeling capabilities inspired by the FRAM Model Visualizer (FMV). 
    It provides interpretation profiles for different analysis contexts, metadata facilities for enhanced modeling, 
    and comprehensive analysis features for professional-grade FRAM applications.</p>
    
    <p>The node supports both traditional FRAM analysis and modern enhancements including ontological mappings, 
    hierarchical grouping, and standardized reporting compatible with current FRAM research and practice.</p>
</script>

<style>
    /* Custom hexagonal node styling */
    .red-ui-flow-node.red-ui-flow-node-type-fram {
        border-radius: 0;
    }
    
    .red-ui-flow-node.red-ui-flow-node-type-fram .red-ui-flow-node-body {
        border-radius: 0;
        clip-path: polygon(25% 0%, 75% 0%, 100% 50%, 75% 100%, 25% 100%, 0% 50%);
        background: linear-gradient(135deg, #4CAF50, #2E7D32);
        border: 2px solid #1B5E20;
        position: relative;
    }
    
    .red-ui-flow-node.red-ui-flow-node-type-fram .red-ui-flow-node-body::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(135deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05));
        clip-path: inherit;
    }
    
    /* Hexagonal shape for FRAM node */
    .red-ui-flow-node-type-fram .red-ui-flow-node-body {
        width: 60px;
        height: 52px;
        background: #4CAF50;
        position: relative;
        margin: 14px 0;
    }
    
    .red-ui-flow-node-type-fram .red-ui-flow-node-body::before,
    .red-ui-flow-node-type-fram .red-ui-flow-node-body::after {
        content: "";
        position: absolute;
        width: 0;
        border-left: 30px solid transparent;
        border-right: 30px solid transparent;
    }
    
    .red-ui-flow-node-type-fram .red-ui-flow-node-body::before {
        bottom: 100%;
        border-bottom: 15px solid #4CAF50;
    }
    
    .red-ui-flow-node-type-fram .red-ui-flow-node-body::after {
        top: 100%;
        border-top: 15px solid #4CAF50;
    }
    
    /* FRAM node label positioning */
    .red-ui-flow-node-type-fram .red-ui-flow-node-label {
        color: white;
        font-weight: bold;
        font-size: 10px;
        text-align: center;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 10;
    }
    
    /* Port positioning for hexagonal shape */
    .red-ui-flow-node-type-fram .red-ui-flow-port {
        border: 1px solid #1B5E20;
        background: #2E7D32;
    }
    
    /* Input port positioning on hexagon edges */
    .red-ui-flow-node-type-fram .red-ui-flow-port-input {
        background: #FF9800;
        border-color: #F57C00;
    }
    
    /* Position inputs around hexagon edges */
    .red-ui-flow-node-type-fram .red-ui-flow-port-input:nth-child(1) {
        top: 0px;
        left: 15px;
    }
    
    .red-ui-flow-node-type-fram .red-ui-flow-port-input:nth-child(2) {
        top: 15px;
        left: 0px;
    }
    
    .red-ui-flow-node-type-fram .red-ui-flow-port-input:nth-child(3) {
        top: 45px;
        left: 0px;
    }
    
    .red-ui-flow-node-type-fram .red-ui-flow-port-input:nth-child(4) {
        top: 60px;
        left: 15px;
    }
    
    .red-ui-flow-node-type-fram .red-ui-flow-port-input:nth-child(5) {
        top: 45px;
        right: 0px;
    }
    
    /* Output port on right edge */
    .red-ui-flow-node-type-fram .red-ui-flow-port-output {
        background: #2196F3;
        border-color: #1976D2;
        top: 30px;
        right: -5px;
    }
    
    /* Selected state styling */
    .red-ui-flow-node.red-ui-flow-node-type-fram.red-ui-flow-node-selected .red-ui-flow-node-body {
        border-color: #FFD54F;
        box-shadow: 0 0 10px rgba(255, 213, 79, 0.8);
    }
    
    /* FRAM node icon */
    .red-ui-flow-node-type-fram .red-ui-flow-node-icon {
        background-image: url("data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='white'%3E%3Cpath d='M12 2L22 8.5v7L12 22 2 15.5v-7L12 2z'/%3E%3C/svg%3E");
        background-size: contain;
        background-repeat: no-repeat;
        background-position: center;
        width: 16px;
        height: 16px;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
    }
</style>

<script type="text/javascript">
    RED.nodes.registerType('fram', {
        category: 'function',
        color: '#4CAF50',
        defaults: {
            name: { value: "" },
            functionName: { value: "FRAM Function" },
            interpretationProfile: { value: "technological" },
            variabilityMode: { value: "normal" },
            timeConstraint: { value: "" },
            resourceThreshold: { value: 100, validate: RED.validators.number() },
            enableResonance: { value: false },
            enableMetadata: { value: false },
            advancedAnalysis: { value: false },
            standardizedReporting: { value: false },
            hierarchicalGroup: { value: "" },
            ontologyMapping: { value: {} }
        },
        inputs: 5,
        outputs: 1,
        inputLabels: function(index) {
            const labels = ["Input (I)", "Preconditions (P)", "Resources (R)", "Time (T)", "Control (C)"];
            return labels[index] || "Input " + (index + 1);
        },
        outputLabels: "Output (O)",
        icon: "function.svg",
        label: function() {
            var profileAbbrev = "";
            switch(this.interpretationProfile) {
                case "technological": profileAbbrev = "[T]"; break;
                case "human": profileAbbrev = "[H]"; break;
                case "organizational": profileAbbrev = "[O]"; break;
                default: profileAbbrev = "";
            }
            
            var baseName = this.name || this.functionName || "FRAM";
            return baseName + (profileAbbrev ? " " + profileAbbrev : "");
        },
        labelStyle: function() {
            return this.name ? "node_label_italic" : "";
        },
        oneditprepare: function() {
            var node = this;
            
            // Profile descriptions
            var profileDescriptions = {
                technological: "Optimized for technical systems with high precision timing and processing requirements. Emphasizes system performance, reliability, and technical metrics.",
                human: "Focused on human factors analysis with cognitive load, decision-making, and situational awareness considerations. Accounts for human variability and adaptation.",
                organizational: "Designed for organizational processes with policy compliance, resource management, and coordination focus. Emphasizes process maturity and stakeholder alignment."
            };
            
            // Profile details for info box
            var profileDetails = {
                technological: {
                    focus: "Technical Systems",
                    keyAspects: "Input (25%), Output (25%), Resources (20%)",
                    variabilityFactors: "System load, Processing capability, Interface quality",
                    executionRequires: "Input + Resources"
                },
                human: {
                    focus: "Human Factors", 
                    keyAspects: "Preconditions (25%), Input (20%), Output (20%)",
                    variabilityFactors: "Cognitive load, Experience level, Fatigue, Situational awareness",
                    executionRequires: "Input + Preconditions (authorization/training)"
                },
                organizational: {
                    focus: "Organizational Processes",
                    keyAspects: "Preconditions (30%), Resources (25%), Output (20%)",
                    variabilityFactors: "Policy compliance, Resource availability, Communication quality",
                    executionRequires: "Preconditions + Resources"
                }
            };
            
            // Initialize form values
            $("#node-input-interpretationProfile").val(this.interpretationProfile || "technological");
            $("#node-input-variabilityMode").val(this.variabilityMode || "normal");
            $("#node-input-resourceThreshold").val(this.resourceThreshold || 100);
            $("#node-input-enableResonance").prop('checked', this.enableResonance || false);
            $("#node-input-enableMetadata").prop('checked', this.enableMetadata || false);
            $("#node-input-advancedAnalysis").prop('checked', this.advancedAnalysis || false);
            $("#node-input-standardizedReporting").prop('checked', this.standardizedReporting || false);
            $("#node-input-hierarchicalGroup").val(this.hierarchicalGroup || "");
            
            // Initialize ontology mapping fields if they exist
            if (this.ontologyMapping) {
                $("#node-input-ontology-input").val(this.ontologyMapping.input || "");
                $("#node-input-ontology-resources").val(this.ontologyMapping.resources || "");
                $("#node-input-ontology-control").val(this.ontologyMapping.control || "");
            }
            
            // Update profile description
            function updateProfileDescription() {
                var profile = $("#node-input-interpretationProfile").val();
                $("#profile-description").text(profileDescriptions[profile] || "");
                
                // Update detailed profile information
                var details = profileDetails[profile];
                if (details) {
                    $("#profile-details").html(
                        "<strong>Focus:</strong> " + details.focus + "<br>" +
                        "<strong>Key Aspects:</strong> " + details.keyAspects + "<br>" +
                        "<strong>Variability Factors:</strong> " + details.variabilityFactors + "<br>" +
                        "<strong>Execution Requires:</strong> " + details.executionRequires
                    );
                }
            }
            
            // Update metadata options visibility
            function updateMetadataVisibility() {
                var enableMetadata = $("#node-input-enableMetadata").prop('checked');
                var advancedAnalysis = $("#node-input-advancedAnalysis").prop('checked');
                
                if (enableMetadata || advancedAnalysis) {
                    $("#metadata-options").show();
                    $("#hierarchical-group-row").show();
                    $("#ontology-header").show();
                    $("#ontology-options").show();
                } else {
                    $("#metadata-options").hide();
                    $("#hierarchical-group-row").hide();
                    $("#ontology-header").hide();
                    $("#ontology-options").hide();
                }
            }
            
            // Event handlers
            $("#node-input-interpretationProfile").on('change', updateProfileDescription);
            $("#node-input-enableMetadata").on('change', updateMetadataVisibility);
            $("#node-input-advancedAnalysis").on('change', updateMetadataVisibility);
            
            // Initialize displays
            updateProfileDescription();
            updateMetadataVisibility();
        },
        oneditsave: function() {
            // Save form values
            this.interpretationProfile = $("#node-input-interpretationProfile").val();
            this.variabilityMode = $("#node-input-variabilityMode").val();
            this.resourceThreshold = parseInt($("#node-input-resourceThreshold").val()) || 100;
            this.enableResonance = $("#node-input-enableResonance").prop('checked');
            this.enableMetadata = $("#node-input-enableMetadata").prop('checked');
            this.advancedAnalysis = $("#node-input-advancedAnalysis").prop('checked');
            this.standardizedReporting = $("#node-input-standardizedReporting").prop('checked');
            this.hierarchicalGroup = $("#node-input-hierarchicalGroup").val();
            
            // Save ontology mapping
            this.ontologyMapping = {
                input: $("#node-input-ontology-input").val(),
                resources: $("#node-input-ontology-resources").val(),
                control: $("#node-input-ontology-control").val()
            };
        },
        paletteLabel: "FRAM Advanced"
    });
</script>